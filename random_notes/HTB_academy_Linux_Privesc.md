# Hack The Box academy Linux Privilege Escalation notes
## Introduction to Linux Privilege Escalation
### Short list
* basic things to check
  * OS version, kernel version, running services
* basic commands
  * ps aux | grep root (root processes)
  * ps au (similar than ps aux)
  * ls -la /, ls -la /home, ls -la /home/user1, ls -la /home/user1/.ssh
  * history, sudo -l, crontab -l, cat /etc/*cron*, ls -la /etc/*cron*
  * cat /etc/passwd, cat /etc/shadow
  * lsblk (Unmounted File Systems and Additional Drives)
  * setuid-, setgid permissions
  * writeable directories
    * find / -path /proc -prune -o -type d -perm -o+w 2>/dev/null
  * writeable files
    * find / -path /proc -prune -o -type f -perm -o+w 2>/dev/null
### some detailed info
* OS Version: Knowing the distribution (Ubuntu, Debian, FreeBSD, Fedora, SUSE, Red Hat, CentOS, etc.) will give you an idea of the types of tools that may be available. This would also identify the operating system version, for which there may be public exploits available.
* Kernel Version: As with the OS version, there may be public exploits that target a vulnerability in a specific kernel version. Kernel exploits can cause system instability or even a complete crash. Be careful running these against any production system, and make sure you fully understand the exploit and possible ramifications before running one.
* Running Services: Knowing what services are running on the host is important, especially those running as root. A misconfigured or vulnerable service running as root can be an easy win for privilege escalation. Flaws have been discovered in many common services such as Nagios, Exim, Samba, ProFTPd, etc. Public exploit PoCs exist for many of them, such as CVE-2016-9566, a local privilege escalation flaw in Nagios Core < 4.2.4.
## Environment Enumeration
* whoami, id, hostname, ifconfig (or ip a), sudo -l
* cat /etc/os-release (new or old linux system is used?) (if old, maybe it has known vulnerabilities)
* echo $PATH
* env
* uname -a (or cat /proc/version) (kernel version)
* lscpu (CPU type and version)
* cat /etc/shells (what shells are available?) (tmux and screen could be vulnerable!!)
* during enumeration we should note any defense system we found
  * e.g.: Exec Shield, iptables, AppArmor, SELinux, Fail2ban, Snort, Uncomplicated Firewall (ufw)
  * enumerating these systems not always works (because the lack of privileges)
  * but knowing them exist can help our strategy (not to test things that has extra defense...)
* lsblk (list hard disks, USB drives, optical drives, etc.)
* lpstat (printers)
* cat /etc/fstab (mounted and unmounted drives)
* route (or netstat -rn) (routing tables)
* /etc/resolv.conf (dns information) (important in domain environment !!!)
* arp -a
* cat /etc/passwd, cat /etc/shadow, cat /etc/group
* cat /etc/passwd | grep "*sh$" (users with shell)
  * some shell version is vulnerable (like bash v4.1 is vulnerable to shellshock)
* getent group group_name1 (lists members of a group)
* check the content of folders in home folders
* check configuration files
  * ends with .conf or .config
  * grep for usernames, passwords, credentials, secrets, ...
* if we found passwords we should try them for all users - maybe it will be working with one of them
* mounting and unmounting filesystems
  * by default it needs root priv to mount and umount file systems
    * for lateral movement the root access is the key to check everything to move on to the next system
* df -h (list mounted file systems)
* cat /etc/fstab | grep -v "#" | column -t (view unmounted file systems)
* find / -type f -name ".*" -exec ls -l {} \; 2>/dev/null | grep user1 (list all hidden files)
* find / -type d -name ".*" -ls 2>/dev/null (list all hidden directories)
* temporary directories
  * /tmp, /var/tmp
  * all users can read the contents of these folders (by default)
* ls -l /tmp /var/tmp /dev/shm (list temporary files)
## Linux Services & Internals Enumeration
### Internals
<pre>
# basic commands
ip a, ifconfig, cat /etc/hosts, history, ls -la /etc/cron.daily/
lastlog (ki mikor jelentkezett be)
who, finger (ki van most eppen bejelentkezve)

# finding history files
find / -type f \( -name *_hist -o -name *_history \) -exec ls -l {} \; 2>/dev/null
</pre>
The proc filesystem (proc / procfs) is a particular filesystem in Linux that contains information about system processes, hardware, and other system information. It is the primary way to access process information and can be used to view and modify kernel settings. It is virtual and does not exist as a real filesystem but is dynamically generated by the kernel. It can be used to look up system information such as the state of running processes, kernel parameters, system memory, and devices. It also sets certain system parameters, such as process priority, scheduling, and memory allocation.  
<pre>
# print proc information
find /proc -name cmdline -exec cat {} \; 2>/dev/null | tr " " "\n"
</pre>
### Services
If it is a slightly older Linux system, the likelihood increases that we can find installed packages that may already have at least one vulnerability. However, current versions of Linux distributions can also have older packages or software installed that may have such vulnerabilities. Therefore, we will see a method to help us detect potentially dangerous packages in a bit. To do this, we first need to create a list of installed packages to work with.  
<pre>
# installed packages
apt list --installed | tr "/" " " | cut -d" " -f1,3 | sed 's/[0-9]://g' | tee -a installed_pkgs.list

# sudo version
sudo -V

# list binary files on the system
ls -l /bin /usr/bin/ /usr/sbin/

# list GTFO bins on the system
for i in $(curl -s https://gtfobins.github.io/ | html2text | cut -d" " -f1 | sed '/^[[:space:]]*$/d');do if grep -q "$i" installed_pkgs.list;then echo "Check GTFO for: $i";fi;done

# trace system calls
strace ./file1

# check configuration files
# if a file has read permissions for everyone, we can still read the file even if we do not have permission to read the folder.
find / -type f \( -name *.conf -o -name *.config \) -exec ls -l {} \; 2>/dev/null

# find scripts on the system
find / -type f -name "*.sh" 2>/dev/null | grep -v "src\|snap\|share"

# running services by user
# it a script created by the administrator in his path and whose rights have not been restricted, we can run it without going into the root directory.
ps aux | grep root
</pre>
## Credential Hunting
<pre>
cat wp-config.php | grep 'DB_USER\|DB_PASSWORD'
find / ! -path "*/proc/*" -iname "*config*" -type f 2>/dev/null
ls ~/.ssh
</pre>
