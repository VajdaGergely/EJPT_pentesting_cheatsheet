# Hack The Box academy Windows Privilege Escalation notes
## Intro
Note: Depending on how we gain access to a system we may not have many directories that are writeable by our user to upload tools. It is always a safe bet to upload tools to C:\Windows\Temp because the BUILTIN\Users group has write access.  
## Situational Awareness
* Network Information
  * ipconfig /all, arp -a, route print
* Enumerating Protections
<pre>
# Check Windows Defender Status
Get-MpComputerStatus
# List AppLocker Rules
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
# Test AppLocker Policy
Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone
</pre>
## Initial Enumeration
### Windows Enumeration CheatSheet !!!
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md
### Intro
During an assessment, we may gain a low-privileged shell on a Windows host (domain-joined or not) and need to perform privilege escalation to further our access.  
We can escalate privileges to one of the following depending on the system configuration and what type of data we encounter:  
* The highly privileged **NT AUTHORITY\SYSTEM** account, or **LocalSystem** account which is a highly privileged account with more privileges than a local administrator account and is used to run most Windows services.
* The built-in local **administrator** account. Some organizations disable this account, but many do not. It is not uncommon to see this account reused across multiple systems in a client environment.
* Another local account that is a member of the local **Administrators** group. Any account in this group will have the same privileges as the built-in **administrator** account.
* A standard (non-privileged) domain user who is part of the local **Administrators** group.
* A domain admin (highly privileged in the Active Directory environment) that is part of the local **Administrators** group.
Windows Commands Reference
* Lists lots of manual enumeration tasks
* https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands
### Key Data Points
* **OS name**: Knowing the type of Windows OS (workstation or server) and level (Windows 7 or 10, Server 2008, 2012, 2016, 2019, etc.) will give us an idea of the types of tools that may be available (such as the PowerShell version, or lack thereof on legacy systems. This would also identify the operating system version for which there may be public exploits available.
* **Version**: As with the OS version, there may be public exploits that target a vulnerability in a specific version of Windows. Windows system exploits can cause system instability or even a complete crash. Be careful running these against any production system, and make sure you fully understand the exploit and possible ramifications before running one.
* **Running Services**: Knowing what services are running on the host is important, especially those running as NT AUTHORITY\SYSTEM or an administrator-level account. A misconfigured or vulnerable service running in the context of a privileged account can be an easy win for privilege escalation.
### System Information
List services corresponds to processes:
* tasklist /svc
It is essential to become familiar with standard Windows processes such as:
* Session Manager Subsystem (smss.exe)
* Client Server Runtime Subsystem (csrss.exe)
* WinLogon (winlogon.exe)
* Local Security Authority Subsystem Service (LSASS)
* and Service Host (svchost.exe)
* among others and the services associated with them.
Other processes such as MsMpEng.exe, Windows Defender, are interesting because they can help us map out what protections are in place on the target host that we may have to evade/bypass.
### Display All Environment Variables
* set, echo %PATH%
However, it is not uncommon to find administrators (or applications) modify the PATH. One common example is to place Python or Java in the path, which would allow the execution of Python or . JAR files. If the folder placed in the PATH is writable by your user, it may be possible to perform DLL Injections against other applications.
Remember, when running a program, Windows looks for that program in the CWD (Current Working Directory) first, then from the PATH going left to right. This means if the custom path is placed on the left (before C:\Windows\System32), it is much more dangerous than on the right.  
In addition to the PATH, set can also give up other helpful information such as the HOME DRIVE. In enterprises, this will often be a file share. Navigating to the file share itself may reveal other directories that can be accessed.  
It is not unheard of to be able to access an "IT Directory," which contains an inventory spreadsheet that includes passwords. Additionally, shares are utilized for home directories so the user can log on to other computers and have the same experience/files/desktop/etc. (Roaming Profiles). This may also mean the user takes malicious items with them.
If a file is placed in USERPROFILE\AppData\Microsoft\Windows\Start Menu\Programs\Startup, when the user logs into a different machine, this file will execute.
### View Detailed Configuration Information
The **systeminfo** command will show if the box has been patched recently and if it is a VM.  
If the box has not been patched recently, getting administrator-level access may be as simple as running a known exploit.  
Google the KBs installed under HotFixes (https://www.catalog.update.microsoft.com/Search.aspx?q=hotfix) to get an idea of when the box has been patched.  
* This information isn't always present, as it is possible to hide hotfixes software from non-administrators.
The System Boot Time and OS Version can also be checked to get an idea of the patch level.  
If the box has not been restarted in over six months, chances are it is also not being patched.  
Additionally, many guides will say the Network Information is important as it could indicate a dual-homed machine (connected to multiple networks). Generally speaking, when it comes to enterprises, devices will just be granted access to other networks via a firewall rule and not have a physical cable run to them.  
Comands:
* systeminfo
### Patches and Updates
If systeminfo doesn't display hotfixes, they may be queriable with WMI using the WMI-Command binary with QFE (Quick Fix Engineering) to display patches.  
<pre>
C:\> wmic qfe
</pre>
We can do this with PowerShell as well using the Get-Hotfix cmdlet.  
<pre>
PS C:\> Get-HotFix | ft -AutoSize
</pre>
### Installed Programs
WMI can also be used to display installed software. This information can often guide us towards hard-to-find exploits. Is FileZilla/Putty/etc installed?  
Run **LaZagne** to check if stored credentials for those applications are installed. Also, some programs may be installed and running as a service that is vulnerable.  
<pre>
C:\> wmic product get name
</pre>
We can, of course, do this with PowerShell as well using the Get-WmiObject cmdlet.  
<pre>
PS C:\> Get-WmiObject -Class Win32_Product |  select Name, Version
</pre>
### Display Running Processes (that listening on the network)
Search for those are only available from localhost or some specific network / network card
<pre>
netstat -ano
</pre>
### User & Group Information
<pre>
# Logged-in Users
C:\> query user

# Current User
C:\> echo %USERNAME%
C:\> whoami

# Current User Privileges
C:\> whoami /priv

# Current User Group Information
C:\> whoami /groups

# Get All Users
C:\> net user

# Get All Groups
C:\> net localgroup

# Details About a Group
C:\> net localgroup administrators

# Get Password Policy & Other Account Information
C:\> net accounts
</pre>
## Communication with Processes
* One of the best places to look for privilege escalation is the processes that are running on the system.
* Even if a process is not running as an administrator, it may lead to additional privileges.
* The most common example is discovering a web server like IIS or XAMPP running on the box, placing an aspx/php shell on the box, and gaining a shell as the user running the web server.
  * Generally, this is not an administrator but will often have the SeImpersonate token, allowing for Rogue/Juicy/Lonely Potato to provide SYSTEM permissions.
### Access Tokens
In Windows, access tokens are used to describe the security context (security attributes or rules) of a process or thread. The token includes information about the user account's identity and privileges related to a specific process or thread. When a user authenticates to a system, their password is verified against a security database, and if properly authenticated, they will be assigned an access token. Every time a user interacts with a process, a copy of this token will be presented to determine their privilege level.  
### Methods of communication with processes
#### Enumerating Network Services
<pre>
C:\> netstat -ano
</pre>
#### Named Pipes
Listing named pipes
<pre>
#Listing Named Pipes with Pipelist (Sysinternals tool) (https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist)
C:\> pipelist.exe /accepteula

# Listing Named Pipes with PowerShell
C:\> gci \\.\pipe\
</pre>
After obtaining a listing of named pipes, we can use Accesschk to enumerate the permissions assigned to a specific named pipe by reviewing the Discretionary Access List (DACL), which shows us who has the permissions to modify, write, read, or execute a resource. Let's take a look at the LSASS process. We can also review the DACLs of all named pipes using the command .\accesschk.exe /accepteula \pipe\.  
<pre>
# Reviewing LSASS Named Pipe Permissions
C:\> accesschk.exe /accepteula \\.\Pipe\lsass -v
</pre>
From the output above, we can see that only administrators have full access to the LSASS process, as expected.  
#### Named Pipes Attack Example
Let's walk through an example of taking advantage of an exposed named pipe to escalate privileges. This WindscribeService Named Pipe Privilege Escalation is a great example. Using accesschk we can search for all named pipes that allow write access with a command such as accesschk.exe -w \pipe\* -v and notice that the WindscribeService named pipe allows READ and WRITE access to the Everyone group, meaning all authenticated users.  
* https://www.exploit-db.com/exploits/48021
Confirming with accesschk we see that the Everyone group does indeed have FILE_ALL_ACCESS (All possible access rights) over the pipe.  
<pre>
# Checking WindscribeService Named Pipe Permissions
C:\> accesschk.exe -accepteula -w \pipe\WindscribeService -v

Accesschk v6.13 - Reports effective permissions for securable objects
Copyright ⌐ 2006-2020 Mark Russinovich
Sysinternals - www.sysinternals.com

\\.\Pipe\WindscribeService
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS
</pre>
From here, we could leverage these lax permissions to escalate privileges on the host to SYSTEM.  
## Windows User Privileges
### Windows Privileges Overview
Privileges in Windows are rights that an account can be granted to perform a variety of operations on the local system such as managing services, loading drivers, shutting down the system, debugging an application, and more.  
User and group privileges are stored in a database and granted via an access token when a user logs on to a system.  
An account can have local privileges on a specific computer and different privileges on different systems if the account belongs to an Active Directory domain.  
Each time a user attempts to perform a privileged action, the system reviews the user's access token to see if the account has the required privileges, and if so, checks to see if they are enabled.  
Most privileges are disabled by default. Some can be enabled by opening an administrative cmd.exe or PowerShell console, while others can be enabled manually.  
#### Rights and Privileges in Windows



### SeImpersonate and SeAssignPrimaryToken
### SeDebugPrivilege
### SeTakeOwnershipPrivilege
