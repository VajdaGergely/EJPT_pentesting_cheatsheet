# vulnerability scanning with metasploit
## importing nmap scan results into msf
* $ nmap ... -oX nmap_output_xml
* msf6> db_import ./nmap_output_xml
## vuln scanning with msf
* msf6> db_nmap
* msf6> use axiliary/scanner/portscan/tcp
* msf6> hosts
* msf6> services
* msf6> search type:expoloit name:<specific_service_name_or_version>
  * if short description did not mention exact service version
  * msf6> use exploit/.../<module_name>
  * msf6> info
  * check the description for service versions
* $ searchsploit <specific_service_name_or_version>
### metasploit-autopwn plugin
* source: https://github.com/hahwul/metasploit-autopwn
* needs msf database (services command output)
* $ wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
* $ sudo cp db_autopwn.rb /usr/share/metasploit-framework/plugins/db_autopwn.rb
* msf6> load db_autopwn
* msf6> db_autopwn (print help)
* msf6> db_autopwn -p -t -PI 445
  * -p select modules based on open ports
  * -t show all matchine exploit modules)
  * -PI 445 only exploit hosts with given ports open
  * automatically list matching exploits
* now we should check manually the exact OS version
* and googling the known vulnerabilites and exploits of that version
* and then utilize those exploits in msf (if presented)
### msf analyze command
* info
  * analyzes the msf database content -> hosts, services
  * gives us hints on exploits regarding the host+service presented in the database
  * show us if credentials are required or not
* steps
  * msf6> analyze
  * msf6> vulns
    * shows us identified vulnerabilites
## import nessus scan results into msf
* free version of nessus
  * Nessus Essentials (max 16 ip)
* nessus installation steps
  * register and download deb package
  * dpkg -i <nessus_deb_file>
  * sudo systemctl start nessusd.service
  * sudo systemctl status nessusd.service
  * browser> https://127.0.0.1:8834
  * choose Nessus Essentials
  * skip registration data
  * fill in actication code (got via email after registration)
  * login  admin:password
* configure and run nessus scan
* check report
  * vulnerabilities
  * filter : 'Metasploit Exploit Framework' 'is equal' 'true'
  * filter : 'Severity' 'is equal' 'High'
  * etc...
* export nessus scan results
  * Export / Nessus / Save xml file
* import nessus scan result into msf
  * msf6> db_import (shows potential import sources)
  * msf6> db_import ~/nessus_scan.xml
  * msf6> hosts
  * msf6> services
  * msf6> vulns
  * msf6> vulns -p 445 (show only smb vulns - 445/tcp)
* search msf module by cve (or "MS vuln number")
  * msf6> search cve:2017 name:smb
  * msf6> search cve:2017 platform:windows
  * msf6> search MS12-020
## WMAP msf module for web app vulnerability testing
* msf6> load wmap
* wmap_sites (define sites)
  * msf6> wmap_sites (print help page)
  * msf6> wmap_sites -a 10.10.10.2 (add new site)
  * msf6> wmap_sites -l (list sites)
* wmap_targets (define targets)
  * msf6> wmap_targets -h (print help page)
  * msf6> wmap_targets -t http://10.10.10.2/
  * msf6> wmap_targets -l (list targets)
* wmap_run (run scanning through modules)
  * msf6> wmap_run -h (print help page)
  * msf6> wmap_run -t (show enabled modules)
  * msf6> wmap_run -e (running all wmap enabled modules)
* wmap_vulns (list detected vulns)
  * msf6> wmap_vulns -h (print help menu)
  * msf6> wmap_vulns -l (list vulns)
